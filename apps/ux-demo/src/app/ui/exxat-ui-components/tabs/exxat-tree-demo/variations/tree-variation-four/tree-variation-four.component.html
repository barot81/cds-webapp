<div fxLayout="row wrap" fxFlex="100" class="mt-24">
  <div
    class="preview pr-lg-16 mt-16"
    fxLayout="column"
    fxLayoutAlign="start"
    fxFlex.gt-md="50"
    fxFlex="100"
  >
    <mat-card fxLayout="column">
      <div
        FxLayout="row"
        fxLayoutAlign="space-between center"
        fxFlex="100"
        class="pb-16"
      >
        <mat-checkbox
          ><span class="font-weight-600">Select all</span></mat-checkbox
        >
        <span class="font-weight-600" tabindex="0" aria-label="expand all"
          >Expand all</span
        >
      </div>
      <mat-tree
        [dataSource]="dataSource"
        [treeControl]="treeControl"
        class="tree-examples-style"
        tabindex="0"
        aria-label="tree example four"
      >
        <!-- node with checkbox -->
        <mat-tree-node
          *matTreeNodeDef="let node"
          matTreeNodeToggle
          matTreeNodePadding
        >
          <button mat-icon-button disabled></button>
          <div
            fxLayout="row"
            fxLayoutAlign="start start"
            fxFlex="100"
            class="tree-node-hover py-8 px-16 ml-12"
            (click)="activeNode = node"
            [ngClass]="{ 'tree-node-active': activeNode === node }"
          >
            <mat-checkbox
              class="checklist-leaf-node px-8"
              [checked]="checklistSelection.isSelected(node)"
              (change)="todoLeafItemSelectionToggle(node)"
            >
            </mat-checkbox>
            <div
              fxLayout="row"
              fxLayoutAlign="space-between start"
              fxFlex="100"
              class=""
              tabindex="0"
              aria-label="child node"
            >
              <div fxLayout="column" fxLayoutAlign="start start" class="pr-16">
                <span tabindex="0" aria-label="Golden shore medical group"
                  >Golden shore medical group</span
                >
                <span
                  class="text-italic secondary-text"
                  tabindex="0"
                  aria-label="Internal medicine"
                  >Internal medicine</span
                >
              </div>
              <span tabindex="0" aria-label="110">110</span>
            </div>
          </div>
        </mat-tree-node>

        <!-- parent node without plus icon -->
        <mat-tree-node
          *matTreeNodeDef="let node; when: hasChild"
          matTreeNodePadding
          tabindex="0"
          aria-label="parent node"
        >
          <div
            fxLayout="row"
            fxLayoutAlign="start center"
            fxFlex="100"
            class="tree-node-hover py-8 pr-16 pl-4 tree-node-bg"
            (click)="activeNode = node"
            [ngClass]="{ 'tree-node-active': activeNode === node }"
          >
            <button
              mat-icon-button
              matTreeNodeToggle
              class="action-icon mr-4"
              aria-label="toggle button for parent node"
            >
              <i
                aria-hidden="true"
                [ngClass]="
                  treeControl.isExpanded(node)
                    ? 'fa-light fa-chevron-down'
                    : 'fa-light fa-chevron-right'
                "
              ></i>
            </button>

            <mat-checkbox
              [checked]="descendantsAllSelected(node)"
              [indeterminate]="descendantsPartiallySelected(node)"
              (change)="todoItemSelectionToggle(node)"
              class="ml-8 mr-16"
            >
            </mat-checkbox>
            <div
              fxLayout="row"
              fxLayoutAlign="space-between center"
              fxFlex="100"
              tabindex="0"
              aria-label="parent node"
            >
              <div fxLayout="row" fxLayoutAlign="start center">
                <zhealthcare-avatar
                  firstName="Strong"
                  lastName="Anna"
                  tabindex="0"
                  aria-label="avatar "
                ></zhealthcare-avatar>
                <span class="" tabindex="0" aria-label="Strong Anna"
                  >Strong Anna</span
                >
              </div>
              <div tabindex="0" aria-label="200">200</div>
            </div>
          </div>
        </mat-tree-node>
      </mat-tree>
    </mat-card>
  </div>

  <div
    class="preview mt-small-16 mt-16 ml-xs-8"
    fxLayout="column"
    fxLayoutAlign="start"
    fxFlex.gt-md="50"
    fxFlex="100"
  >
    <mat-tab-group>
      <!-- 1st tab content -->
      <mat-tab label="HTML">
        <div class="pt-16">
          <fuse-highlight lang="html" class="source-code">
            <textarea #source hidden="hidden">
              <div FxLayout="row" fxLayoutAlign="space-between center" fxFlex="100" class="pb-16">
                <mat-checkbox><span class="font-weight-600">Select all</span></mat-checkbox>
                <span class="font-weight-600">Expand all</span>
              </div>
              <mat-tree [dataSource]="dataSource" [treeControl]="treeControl" class="tree-examples-style" tabindex="0" aria-label="tree example four">
                <!-- node with checkbox -->
                <mat-tree-node *matTreeNodeDef="let node" matTreeNodeToggle matTreeNodePadding>
                  <button mat-icon-button disabled></button>
                  <div fxLayout="row" fxLayoutAlign="start start" fxFlex="100" class="tree-node-hover py-8 px-16 ml-12"  (click)="activeNode = node" [ngClass]="{ 'tree-node-active': activeNode === node }">
                      <mat-checkbox class="checklist-leaf-node px-8" [checked]="checklistSelection.isSelected(node)"
                        (change)="todoLeafItemSelectionToggle(node)">
                      </mat-checkbox>
                      <div fxLayout="row" fxLayoutAlign="space-between start" fxFlex="100" class="" tabindex="0" aria-label="child node">
                        <div fxLayout="column" fxLayoutAlign="start start" class="pr-16">
                          <span tabindex="0" aria-label="Golden shore medical group">Golden shore medical group</span>
                          <span class="text-italic secondary-text" tabindex="0" aria-label="Internal medicine">Internal medicine</span>
                        </div>
                        <span tabindex="0" aria-label="110">110</span>
                      </div>

                  </div>
                </mat-tree-node>

                <!-- parent node without plus icon -->
                <mat-tree-node *matTreeNodeDef="let node; when: hasChild" matTreeNodePadding tabindex="0" aria-label="parent node">
                  <div fxLayout="row" fxLayoutAlign="start center" fxFlex="100" class="tree-node-hover py-8 px-16 tree-node-bg" (click)="activeNode = node" [ngClass]="{ 'tree-node-active': activeNode === node }">
                      <button mat-icon-button matTreeNodeToggle class="action-icon mr-4"
                         aria-label="toggle button for parent node">
                        <i [ngClass]="treeControl.isExpanded(node) ? 'fa-light fa-chevron-down' : 'fa-light fa-chevron-right'"
                          ></i>
                      </button>

                      <mat-checkbox [checked]="descendantsAllSelected(node)" [indeterminate]="descendantsPartiallySelected(node)"
                        (change)="todoItemSelectionToggle(node)" class="ml-8 mr-16">
                      </mat-checkbox>
                        <div fxLayout="row" fxLayoutAlign="space-between center" fxFlex="100"  tabindex="0" aria-label="parent node">
                          <div fxLayout="row" fxLayoutAlign="start center">
                            <zhealthcare-avatar firstName="Strong" lastName="Anna" tabindex="0" aria-label="avatar "></zhealthcare-avatar>
                            <span class="" tabindex="0" aria-label="Strong Anna">Strong Anna</span>
                          </div>
                          <div tabindex="0" aria-label="200">200</div>
                        </div>

                  </div>

                </mat-tree-node>
              </mat-tree>
           </textarea
            >
          </fuse-highlight>
        </div>
      </mat-tab>

      <mat-tab label="TS">
        <div class="pt-16">
          <fuse-highlight lang="ts" class="source-code">
            <textarea #source hidden="hidden">

                import { SelectionModel } from '@angular/cdk/collections';
                import { FlatTreeControl } from '@angular/cdk/tree';
                import { Component } from '@angular/core';
                import { MatTreeFlatDataSource, MatTreeFlattener } from '@angular/material/tree';
                import { ChecklistDatabase, TodoItemFlatNode, TodoItemNode } from '../tree-data.service';

                @Component({
                  selector: 'ryzen-tree-variation-four',
                  templateUrl: './tree-variation-four.component.html',
                  styleUrls: ['./tree-variation-four.component.scss']
                })
                export class TreeVariationFourComponent {
                  activeNode;
                  flatNodeMap = new Map<TodoItemFlatNode, TodoItemNode>();
                  nestedNodeMap = new Map<TodoItemNode, TodoItemFlatNode>();
                  selectedParent: TodoItemFlatNode | null = null;
                  newItemName = '';
                  treeControl: FlatTreeControl<TodoItemFlatNode>;
                  treeFlattener: MatTreeFlattener<TodoItemNode, TodoItemFlatNode>;
                  dataSource: MatTreeFlatDataSource<TodoItemNode, TodoItemFlatNode>;
                  checklistSelection = new SelectionModel<TodoItemFlatNode>(true);

                  constructor(private _database: ChecklistDatabase) {
                    this.treeFlattener = new MatTreeFlattener(this.transformer, this.getLevel,
                      this.isExpandable, this.getChildren);
                    this.treeControl = new FlatTreeControl<TodoItemFlatNode>(this.getLevel, this.isExpandable);
                    this.dataSource = new MatTreeFlatDataSource(this.treeControl, this.treeFlattener);

                    _database.dataChange.subscribe(data => {
                      this.dataSource.data = data;
                    });
                  }
                  getLevel = (node: TodoItemFlatNode) => node.level;

                  isExpandable = (node: TodoItemFlatNode) => node.expandable;

                  getChildren = (node: TodoItemNode): TodoItemNode[] => node.children;

                  hasChild = (_: number, _nodeData: TodoItemFlatNode) => _nodeData.expandable;

                  hasNoContent = (_: number, _nodeData: TodoItemFlatNode) => _nodeData.item === '';

                  /**
                  * Transformer to convert nested node to flat node. Record the nodes in maps for later use.
                  */
                  transformer = (node: TodoItemNode, level: number) => {
                    const existingNode = this.nestedNodeMap.get(node);
                    const flatNode = existingNode && existingNode.item === node.item
                      ? existingNode
                      : new TodoItemFlatNode();
                    flatNode.item = node.item;
                    flatNode.level = level;
                    flatNode.expandable = !!node.children?.length;
                    this.flatNodeMap.set(flatNode, node);
                    this.nestedNodeMap.set(node, flatNode);
                    return flatNode;
                  }

                  /** Whether all the descendants of the node are selected. */
                  descendantsAllSelected(node: TodoItemFlatNode): boolean {
                    const descendants = this.treeControl.getDescendants(node);
                    const descAllSelected = descendants.length > 0 && descendants.every(child => {
                      return this.checklistSelection.isSelected(child);
                    });
                    return descAllSelected;
                  }

                  /** Whether part of the descendants are selected */
                  descendantsPartiallySelected(node: TodoItemFlatNode): boolean {
                    const descendants = this.treeControl.getDescendants(node);
                    const result = descendants.some(child => this.checklistSelection.isSelected(child));
                    return result && !this.descendantsAllSelected(node);
                  }

                  /** Toggle the to-do item selection. Select/deselect all the descendants node */
                  todoItemSelectionToggle(node: TodoItemFlatNode): void {
                    this.checklistSelection.toggle(node);
                    const descendants = this.treeControl.getDescendants(node);
                    this.checklistSelection.isSelected(node)
                      ? this.checklistSelection.select(...descendants)
                      : this.checklistSelection.deselect(...descendants);

                    // Force update for the parent
                    descendants.forEach(child => this.checklistSelection.isSelected(child));
                    this.checkAllParentsSelection(node);
                  }

                  /** Toggle a leaf to-do item selection. Check all the parents to see if they changed */
                  todoLeafItemSelectionToggle(node: TodoItemFlatNode): void {
                    this.checklistSelection.toggle(node);
                    this.checkAllParentsSelection(node);
                  }

                  /* Checks all the parents when a leaf node is selected/unselected */
                  checkAllParentsSelection(node: TodoItemFlatNode): void {
                    let parent: TodoItemFlatNode | null = this.getParentNode(node);
                    while (parent) {
                      this.checkRootNodeSelection(parent);
                      parent = this.getParentNode(parent);
                    }
                  }

                  /** Check root node checked state and change it accordingly */
                  checkRootNodeSelection(node: TodoItemFlatNode): void {
                    const nodeSelected = this.checklistSelection.isSelected(node);
                    const descendants = this.treeControl.getDescendants(node);
                    const descAllSelected = descendants.length > 0 && descendants.every(child => {
                      return this.checklistSelection.isSelected(child);
                    });
                    if (nodeSelected && !descAllSelected) {
                      this.checklistSelection.deselect(node);
                    } else if (!nodeSelected && descAllSelected) {
                      this.checklistSelection.select(node);
                    }
                  }

                  /* Get the parent node of a node */
                  getParentNode(node: TodoItemFlatNode): TodoItemFlatNode | null {
                    const currentLevel = this.getLevel(node);

                    if (currentLevel < 1) {
                      return null;
                    }

                    const startIndex = this.treeControl.dataNodes.indexOf(node) - 1;

                    for (let i = startIndex; i >= 0; i--) {
                      const currentNode = this.treeControl.dataNodes[i];

                      if (this.getLevel(currentNode) < currentLevel) {
                        return currentNode;
                      }
                    }
                    return null;
                  }

                  /** Select the category so we can insert the new item. */
                  addNewItem(node: TodoItemFlatNode) {
                    const parentNode = this.flatNodeMap.get(node);
                    this._database.insertItem(parentNode!, '');
                    this.treeControl.expand(node);
                  }

                  /** Save the node to database */
                  saveNode(node: TodoItemFlatNode, itemValue: string) {
                    const nestedNode = this.flatNodeMap.get(node);
                    this._database.updateItem(nestedNode!, itemValue);
                  }
                }


           </textarea
            >
          </fuse-highlight>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
</div>
